{% extends "base/base.html" %} 
{% block title %}Recommendations{% endblock title %}
{% load static %}{% block start %}

    <style>
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Color palette styles */
        .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: inline-block;
            margin-right: 4px;
        }
        
        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
        }
        
        .recommended-colors {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }
        
        .color-match-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
        }
        
        /* Color mapping for display */
        .color-navy-blue { background-color: #1e3a8a; }
        .color-emerald-green { background-color: #10b981; }
        .color-burgundy { background-color: #7c2d12; }
        .color-coral { background-color: #ff7875; }
        .color-turquoise { background-color: #06b6d4; }
        .color-golden-yellow { background-color: #f59e0b; }
        .color-cream { background-color: #fef3c7; }
        .color-burnt-orange { background-color: #ea580c; }
        .color-deep-purple { background-color: #7c3aed; }
        .color-royal-blue { background-color: #2563eb; }
        .color-forest-green { background-color: #166534; }
        .color-crimson { background-color: #dc2626; }
        .color-gold { background-color: #fbbf24; }
        .color-chocolate-brown { background-color: #92400e; }
        .color-ivory { background-color: #fffbeb; }
        .color-terracotta { background-color: #c2410c; }
        .color-bright-white { background-color: #ffffff; border: 1px solid #d1d5db; }
        .color-electric-blue { background-color: #3b82f6; }
        .color-hot-pink { background-color: #ec4899; }
        .color-lime-green { background-color: #65a30d; }
        .color-orange { background-color: #f97316; }
        .color-yellow { background-color: #eab308; }
        .color-red { background-color: #ef4444; }
        .color-purple { background-color: #a855f7; }
        .color-soft-pastels { background: linear-gradient(45deg, #fce7f3, #e0e7ff, #f0fdf4); }
        .color-light-blue { background-color: #93c5fd; }
        .color-lavender { background-color: #c4b5fd; }
        .color-pink { background-color: #f9a8d4; }
        .color-mint-green { background-color: #86efac; }
        .color-peach { background-color: #fed7aa; }
        .color-baby-blue { background-color: #bfdbfe; }
        .color-rose-gold { background: linear-gradient(45deg, #fca5a5, #fbbf24); }
        .color-black { background-color: #000000; }
        .color-blue { background-color: #3b82f6; }
        .color-green { background-color: #22c55e; }
        .color-white { background-color: #ffffff; border: 1px solid #d1d5db; }
        .color-grey { background-color: #6b7280; }
        .color-gray { background-color: #6b7280; }
        .color-brown { background-color: #92400e; }
        .color-maroon { background-color: #7f1d1d; }
        .color-silver { background-color: #e5e7eb; }
        .color-navy { background-color: #1e3a8a; }
        .color-lilac { background-color: #c4b5fd; }
    </style>

<!DOCTYPE html>
<html lang="en">
  <head>
     <script src="https://cdn.tailwindcss.com"></script>
    </head>

<body class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">AI Fashion Stylist</h1>
            <p class="text-gray-600">Personalized clothing recommendations powered by machine learning</p>
        </div>

        {% if not has_preferences %}
        <!-- No Preferences Message -->
        <div class="max-w-2xl mx-auto p-6 bg-white rounded-lg shadow-lg text-center">
            <div class="mb-6">
                <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Complete Your Style Profile First</h2>
            <p class="text-gray-600 mb-6">
                To get personalized recommendations, please complete your style preferences first.
            </p>
            <a href="{% url 'style-quiz' %}" 
               class="bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 px-6 rounded-md font-medium hover:from-blue-700 hover:to-purple-700 transition-all duration-200">
                Complete Style Profile
            </a>
        </div>
        {% else %}
        <!-- Main Recommendation Interface -->
        <div class="max-w-6xl mx-auto">
            <!-- Search Input Section -->
            <div class="max-w-2xl mx-auto mb-8">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">What are you looking for?</h2>
                    <div class="space-y-4">
                        <textarea
                            id="userPrompt"
                            class="w-full p-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 min-h-32 resize-none"
                            placeholder="Describe what you're looking for... e.g., 'I need a casual summer shirt for outdoor activities' or 'Looking for formal wear for a wedding'"
                        ></textarea>
                        <button
                            id="getRecommendations"
                            class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 px-6 rounded-md font-medium hover:from-blue-700 hover:to-purple-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            Get Personalized Recommendations
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="hidden text-center py-12">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-600">Finding your perfect matches...</p>
            </div>

            <!-- Color Recommendations Display -->
            <div id="colorRecommendationsSection" class="hidden max-w-4xl mx-auto mb-8">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">
                        <span class="inline-flex items-center">
                            <svg class="w-5 h-5 mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                            </svg>
                            Colors That Complement Your Skin Tone
                        </span>
                    </h3>
                    <div id="colorRecommendationsContent">
                        <!-- Color recommendations will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Recommendations Section -->
            <div id="recommendationsSection" class="hidden">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Your Personalized Recommendations</h2>
                    <p id="clusterInfo" class="text-gray-600"></p>
                </div>
                
                <div id="recommendationsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Recommendations will be inserted here -->
                </div>
                
                <div class="text-center mt-8">
                    <button
                        id="newSearch"
                        class="bg-gray-600 text-white px-6 py-3 rounded-md hover:bg-gray-700 transition-colors"
                    >
                        Start New Search
                    </button>
                </div>
            </div>

            <!-- No Results State -->
            <div id="noResultsState" class="hidden text-center py-12">
                <div class="mb-6">
                    <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.595 0-5.067.48-7.265 1.291" />
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">No Recommendations Found</h3>
                <p class="text-gray-600 mb-4">Try adjusting your search terms or preferences.</p>
                <button
                    id="tryAgain"
                    class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition-colors"
                >
                    Try Different Search
                </button>
            </div>

            <!-- Current Preferences Display -->
            <div class="max-w-2xl mx-auto mt-8 bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Your Current Style Profile</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="font-medium text-gray-700">Body Shape:</span>
                        <span class="text-gray-600">{{ user_preferences.body_shape|default:"Not specified" }}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Style:</span>
                        <span class="text-gray-600">{{ user_preferences.clothing_types|default:"Not specified" }}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Skin Tone:</span>
                        <span class="text-gray-600">{{ user_preferences.skin_tone|default:"Not specified" }}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Budget:</span>
                        <span class="text-gray-600">{{ user_preferences.budget_range|default:"Not specified" }}</span>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-100">
                    <a href="{% url 'style_quiz' %}" 
                       class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                        Update Your Preferences
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const userPrompt = document.getElementById('userPrompt');
            const getRecommendationsBtn = document.getElementById('getRecommendations');
            const loadingState = document.getElementById('loadingState');
            const recommendationsSection = document.getElementById('recommendationsSection');
            const colorRecommendationsSection = document.getElementById('colorRecommendationsSection');
            const colorRecommendationsContent = document.getElementById('colorRecommendationsContent');
            const noResultsState = document.getElementById('noResultsState');
            const recommendationsList = document.getElementById('recommendationsList');
            const clusterInfo = document.getElementById('clusterInfo');
            const newSearchBtn = document.getElementById('newSearch');
            const tryAgainBtn = document.getElementById('tryAgain');

            // Get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // Hide all states initially
            function hideAllStates() {
                loadingState.classList.add('hidden');
                recommendationsSection.classList.add('hidden');
                colorRecommendationsSection.classList.add('hidden');
                noResultsState.classList.add('hidden');
            }

            // Function to display color recommendations
            function displayColorRecommendations(recommendedColors, skinTone) {
                const bestColors = recommendedColors.best || [];
                const avoidColors = recommendedColors.avoid || [];
                
                colorRecommendationsContent.innerHTML = `
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-medium text-gray-700 mb-3 flex items-center">
                                <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                                Best Colors for ${skinTone} Skin Tone
                            </h4>
                            <div class="color-palette flex-wrap">
                                ${bestColors.map(color => {
                                    const colorClass = 'color-' + color.toLowerCase().replace(/\s+/g, '-');
                                    return `
                                        <div class="flex items-center mb-2 mr-4">
                                            <div class="color-dot ${colorClass}" title="${color}"></div>
                                            <span class="text-sm text-gray-600 ml-1 capitalize">${color}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        ${avoidColors.length > 0 ? `
                        <div>
                            <h4 class="font-medium text-gray-700 mb-3 flex items-center">
                                <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                                Colors to Use Sparingly
                            </h4>
                            <div class="color-palette flex-wrap">
                                ${avoidColors.map(color => {
                                    const colorClass = 'color-' + color.toLowerCase().replace(/\s+/g, '-');
                                    return `
                                        <div class="flex items-center mb-2 mr-4 opacity-60">
                                            <div class="color-dot ${colorClass}" title="${color}"></div>
                                            <span class="text-sm text-gray-500 ml-1 capitalize">${color}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                colorRecommendationsSection.classList.remove('hidden');
            }

            // Helper function to get product colors
            function getProductColors(product) {
                const colors = [];
                
                // Check if product has a color field
                if (product.color) {
                    colors.push(product.color);
                }
                
                // Extract colors from product name and description
                const colorKeywords = ['black', 'white', 'blue', 'red', 'green', 'yellow', 'purple', 'pink', 'orange', 'brown', 'gray', 'grey', 'navy', 'maroon', 'cream', 'beige', 'gold', 'silver'];
                const productText = `${product.name} ${product.description || ''}`.toLowerCase();
                
                colorKeywords.forEach(color => {
                    if (productText.includes(color) && !colors.some(c => c.toLowerCase().includes(color))) {
                        colors.push(color);
                    }
                });
                
                return colors;
            }

            // Helper function to check if product color matches recommended colors
            function isColorRecommended(productColors, recommendedColors) {
                if (!productColors || !recommendedColors || !recommendedColors.best) return false;
                
                return productColors.some(productColor => 
                    recommendedColors.best.some(recColor => 
                        productColor.toLowerCase().includes(recColor.toLowerCase()) ||
                        recColor.toLowerCase().includes(productColor.toLowerCase())
                    )
                );
            }

            // Helper function to update recommendation image when thumbnail is clicked
            function updateRecommendationImage(thumbnailElement, productIndex) {
                const mainImage = document.getElementById(`main-image-${productIndex}`);
                if (mainImage) {
                    mainImage.src = thumbnailElement.src;
                }
            }

            // Helper function to open image in modal
            function openImageModal(imageSrc, productName) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="relative max-w-4xl max-h-screen p-4">
                        <img src="${imageSrc}" alt="${productName}" class="max-w-full max-h-full object-contain">
                        <button onclick="this.parentElement.parentElement.remove()" 
                                class="absolute top-4 right-4 text-white text-2xl hover:text-gray-300">
                            ×
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);

                // Close modal when clicking outside the image
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            // Display recommendations function
            function displayRecommendations(recommendations, cluster, recommendedColors) {
                console.log('Displaying recommendations:', recommendations);
                hideAllStates();
                
                clusterInfo.textContent = `Based on your style profile (Cluster ${cluster}) and search preferences`;
                
                recommendationsList.innerHTML = recommendations.map((product, index) => {
                    // Get the first image or use a placeholder
                    const primaryImage = product.images && product.images.length > 0 
                        ? product.images[0].url 
                        : '/static/images/placeholder.jpg';
            
                    // Create thumbnail images for gallery
                    const thumbnailImages = product.images && product.images.length > 1 
                        ? product.images.slice(1, 4).map(img => `
                            <img src="${img.url}" alt="${img.alt}" 
                                 class="w-12 h-12 object-cover rounded cursor-pointer border border-gray-200 hover:border-blue-400 transition-colors"
                                 onclick="updateRecommendationImage(this, '${index}')">
                          `).join('')
                        : '';

                    // Get product colors and check if they match recommended colors
                    const productColors = getProductColors(product);
                    const isColorMatch = isColorRecommended(productColors, recommendedColors);

                    return `
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden border border-gray-200 hover:shadow-xl transition-shadow duration-300">
                            <!-- Product Image Section -->
                            <div class="relative">
                                <div class="bg-gray-100 aspect-[4/3] overflow-hidden">
                                    <img src="${primaryImage}" 
                                         alt="${product.name}" 
                                         id="main-image-${index}"
                                         class="w-full h-68 object-cover cursor-pointer hover:scale-105 transition-transform duration-300"
                                         onclick="openImageModal('${primaryImage}', '${product.name}')">
                                </div>
                                ${product.images && product.images.length > 1 ? `
                                    <div class="absolute bottom-2 left-2 flex space-x-1">
                                        ${thumbnailImages}
                                    </div>
                                ` : ''}
                                <div class="absolute top-2 right-2">
                                    <span class="bg-gradient-to-r from-blue-600 to-purple-600 text-white text-xs px-2 py-1 rounded-full">
                                        #${index + 1} Match
                                    </span>
                                </div>
                                ${isColorMatch ? `
                                    <div class="absolute top-2 left-2">
                                        <span class="color-match-badge">
                                            Perfect Color Match!
                                        </span>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Product Details Section -->
                            <div class="p-6">
                                <div class="flex justify-between items-start mb-3">
                                    <h3 class="text-lg font-semibold text-gray-800 flex-1">
                                        ${product.name.length > 20 ? product.name.substring(0, 17) + '...' : product.name}
                                    </h3>
                                    <span class="text-lg font-bold text-green-600 ml-2">
                                        PKR ${product.price.toLocaleString()}
                                    </span>
                                </div>
                                
                                <!-- Product Colors Section -->
                                ${productColors.length > 0 ? `
                                    <div class="mb-3">
                                        <div class="flex items-center space-x-2">
                                            <span class="text-sm font-medium text-gray-600">Colors:</span>
                                            <div class="flex space-x-1">
                                                ${productColors.map(color => {
                                                    const colorClass = 'color-' + color.toLowerCase().replace(/\s+/g, '-');
                                                    return `<div class="color-dot ${colorClass}" title="${color}"></div>`;
                                                }).join('')}
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div class="space-y-2 mb-4">
                                    <div class="flex flex-wrap gap-1">
                                        ${product.brand ? `<span class="bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded">${product.brand}</span>` : ''}
                                        ${product.body_shape ? `<span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded">${product.body_shape}</span>` : ''}
                                        ${product.clothing_type ? `<span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded">${product.clothing_type}</span>` : ''}
                                    </div>
                                </div>
                                
                                <div class="space-y-2 mb-4">
                                    <h4 class="text-sm font-medium text-gray-700">Why this matches you:</h4>
                                    <ul class="text-sm text-gray-600 space-y-1">
                                        ${product.match_reasons.map(reason => `
                                            <li class="flex items-start">
                                                <span class="text-green-500 mr-2">•</span>
                                                ${reason}
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                                
                                <div class="mt-4 pt-4 border-t border-gray-100">
                                    <div class="flex justify-between items-center mb-3">
                                        <div class="flex justify-between items-center text-sm text-gray-500">
                                            <span>Similarity Score: </span>
                                            <span class="font-medium">
                                                ${(product.similarity * 100).toFixed(1)}%
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="flex space-x-2">
                                        ${product.slug ? `
                                            <a href="/product/${product.slug}/" 
                                               class="flex-1 bg-blue-600 text-white text-center py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-200 text-sm font-medium">
                                                View Details
                                            </a>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
        
                recommendationsSection.classList.remove('hidden');
            }

            // Enable/disable button based on input
            userPrompt.addEventListener('input', function() {
                getRecommendationsBtn.disabled = !this.value.trim();
            });

            // Get recommendations
            getRecommendationsBtn.addEventListener('click', async function() {
                const prompt = userPrompt.value.trim();
                if (!prompt) return;

                console.log('Getting recommendations for:', prompt);

                hideAllStates();
                loadingState.classList.remove('hidden');
                getRecommendationsBtn.disabled = true;

                try {
                    const response = await fetch('{% url "generate_recommendations" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ prompt: prompt })
                    });

                    console.log('Response status:', response.status);
                    const data = await response.json();
                    console.log('Response data:', data);

                    if (data.success && data.recommendations && data.recommendations.length > 0) {
                        // Display color recommendations first
                        if (data.recommended_colors) {
                            displayColorRecommendations(data.recommended_colors, data.extracted_data?.skin_tone || 'Your');
                        }
                        
                        // Then display product recommendations
                        displayRecommendations(data.recommendations, data.user_cluster, data.recommended_colors);
                    } else {
                        console.log('No recommendations found or empty array');
                        hideAllStates();
                        noResultsState.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Error fetching recommendations:', error);
                    hideAllStates();
                    noResultsState.classList.remove('hidden');
                } finally {
                    getRecommendationsBtn.disabled = false;
                }
            });

            function resetSearch() {
                userPrompt.value = '';
                getRecommendationsBtn.disabled = true;
                hideAllStates();
            }

            // Event listeners
            newSearchBtn.addEventListener('click', resetSearch);
            tryAgainBtn.addEventListener('click', function() {
                hideAllStates();
            });

            // Enable Enter key to submit
            userPrompt.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (this.value.trim() && !getRecommendationsBtn.disabled) {
                        getRecommendationsBtn.click();
                    }
                }
            });

            // Make functions globally accessible for onclick handlers
            window.updateRecommendationImage = updateRecommendationImage;
            window.openImageModal = openImageModal;

            // Initial button state
            getRecommendationsBtn.disabled = true;
        });
    </script>

{% endblock %}