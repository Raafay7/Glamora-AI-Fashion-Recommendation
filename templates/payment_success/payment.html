<form id="payment-form">
    <div id="dropin-container"></div>
    <button id="submit-button">Pay Now</button>
</form>

<script src="https://js.braintreegateway.com/web/dropin/1.33.4/js/dropin.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        fetch("/payments/generate_client_token/")
            .then(response => response.json())
            .then(data => {
                braintree.dropin.create({
                    authorization: data.clientToken,
                    container: "#dropin-container"
                }, function (err, instance) {
                    if (err) {
                        console.error(err);
                        return;
                    }

                    document.querySelector("#submit-button").addEventListener("click", function (event) {
                        event.preventDefault();
                        instance.requestPaymentMethod(function (err, payload) {
                            if (err) {
                                console.error(err);
                                return;
                            }

                            // Send nonce to backend
                            fetch("/payments/process_payment/", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/x-www-form-urlencoded",
                                    "X-CSRFToken": "{{ csrf_token }}"
                                },
                                body: `payment_method_nonce=${payload.nonce}&amount=10.00`
                            })
                            .then(response => response.json())
                            .then(result => {
                                if (result.success) {
                                    alert("Payment successful! Transaction ID: " + result.transaction_id);
                                } else {
                                    alert("Payment failed: " + result.error);
                                }
                            });
                        });
                    });
                });
            });
    });
</script>
